version: "3.7"

services:
  app_proxy:
    environment:
      APP_HOST: gateway
      APP_PORT: 18789
    image: getumbrel/app-proxy:1.0.0@sha256:c402441f880113b992859f8f55565b05c04f618df4f5c355c9e3591eb0cbe81c
    restart: on-failure

  gateway:
    image: ghcr.io/geoffwellman/gw-clawdbot-umbrel:latest
    restart: unless-stopped
    environment:
      # Gateway configuration
      HOME: /root
      NODE_ENV: production
      CLAWDBOT_GATEWAY_TOKEN: ${APP_SEED}
      CLAWDBOT_GATEWAY_BIND: lan
      CLAWDBOT_ALLOW_INSECURE_AUTH: ${CLAWDBOT_ALLOW_INSECURE_AUTH:-true}
      
      # LLM Providers (set at least one)
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      OPENCODE_BASE_URL: ${OPENCODE_BASE_URL:-}
      OPENCODE_MODEL: ${OPENCODE_MODEL:-}
      CLAWDBOT_MODEL: ${CLAWDBOT_MODEL:-}
      
      # Channels
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      TELEGRAM_ALLOWED_USERS: ${TELEGRAM_ALLOWED_USERS:-}
      WHATSAPP_ENABLED: ${WHATSAPP_ENABLED:-false}
      DISCORD_BOT_TOKEN: ${DISCORD_BOT_TOKEN:-}
      SLACK_APP_TOKEN: ${SLACK_APP_TOKEN:-}
      SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN:-}
      
      # Agent settings
      AGENT_TIMEZONE: ${AGENT_TIMEZONE:-UTC}
      ENABLE_BROWSER: ${ENABLE_BROWSER:-true}
      ENABLE_EXEC: ${ENABLE_EXEC:-true}
      
      # Text-to-Speech
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:-}
      
      # Web search
      BRAVE_API_KEY: ${BRAVE_API_KEY:-}

      # Tailscale (generate auth key at https://login.tailscale.com/admin/settings/keys)
      TAILSCALE_AUTHKEY: ${TAILSCALE_AUTHKEY:-}
      TAILSCALE_HOSTNAME: ${TAILSCALE_HOSTNAME:-clawdbot}
      TAILSCALE_SERVE: ${TAILSCALE_SERVE:-true}

    volumes:
      - ${APP_DATA_DIR}/data/config:/root/.clawdbot
      - ${APP_DATA_DIR}/data/workspace:/root/clawd
      - ${APP_DATA_DIR}/data/projects:/root/Projects
      - ${APP_DATA_DIR}/data/claude:/root/.claude
    command: ["node", "dist/index.js", "gateway", "--bind", "lan", "--port", "18789", "--allow-unconfigured"]
